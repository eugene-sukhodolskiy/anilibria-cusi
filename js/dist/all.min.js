class Alert{constructor(e,t,A,r){this.id="alert-id-"+(new Date).getTime()+Math.random(),(alertsList[this.id]=this).type=e,this.content=t||"",this.isSingleton=A||!1,this.isClosable=r||!1;e=document.querySelector('.component.alert[data-id="alert-id-reference"]');if(!e)return console.error("Reference of alert component not found");this.template=e.cloneNode(!0),this.template.getInstance=()=>this,this.initComponent()}initComponent(){this.template.classList.add("alert-"+this.type),this.template.setAttribute("data-id",this.id),this.template.querySelector(".content").innerHTML=this.content,this.template.querySelector(".close-alert").addEventListener("click",e=>{e.preventDefault(),this.close()})}showIn(e){return!!this.template&&(this.isSingleton&&(e.innerHTML=""),e.append(this.template),setTimeout(()=>{this.template.classList.add("show")},10),this)}close(){this.template.classList.remove("show"),setTimeout(()=>{this.template.remove(),delete alertsList[this.id]},150)}changeContent(e){this.template.querySelector(".content").innerHTML=e}}const closeAlertComponent=e=>alertsList[e]?.close(),createAlertComponent=(e,t,A,r)=>new Alert(e,t,A,r),createGlobalAlertComponent=(e,t,A,r)=>{e=createAlertComponent(e,t,A,r);return e.showIn(document.querySelector(".global-alerts-container")),e},alertsList=(document.addEventListener("DOMContentLoaded",e=>{document.querySelectorAll(".component.alert .close-alert").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();e=e.currentTarget.getAttribute("data-close-alert-id");closeAlertComponent(e)})})}),{});class App{constructor(){this.router=new Router(".page-container","home","not-found"),this.auth=new Auth("#login .login-form form"),this.renderer=new Renderer,this.postRender=new PostRender,this.loader=new Loader,this.cacheProvider=new CacheProvider,this.storedPlayerDataManager=new StoredPlayerDataManager,setTimeout(()=>{this.init()},10)}init(){initers(this),this.router.urlMonitor(),this.initDisplayingAuthBtns(),this.initPreloadSpinner(),this.initBaseEvents(),this.initGenres(),this.initGoToTopBtn()}initPreloadSpinner(){document.querySelectorAll(".preload-spinner").forEach(e=>{e.innerHTML=this.renderer.renderPreloadSpinner()})}initBaseEvents(){document.querySelector(".logout-btn").addEventListener("click",e=>{this.auth.logout()}),document.querySelector(".btn-nav-on-mob-show").addEventListener("click",e=>{(e.currentTarget.classList.contains("active")?hideMobNav:showMobNav)()}),document.querySelector('[name="search"]').addEventListener("keyup",e=>{var t;e.preventDefault(),13==e.keyCode&&(t=e.currentTarget.value.trim(),document.location.hash="page:search;sq:"+t,e.currentTarget.blur())});const a={home:this.loader.homePageUpToLoad,search:this.loader.searchPageUpToLoad,genres:this.loader.genresPageUpToLoad};for(let r in a){const s=document.querySelector("#"+r);s.querySelector(".more-btn").addEventListener("click",e=>{const t=s.querySelector(".render-container");var A=t.childNodes.length;s.querySelector(".more-btn-wrap .preload-spinner").classList.remove("dnone"),s.querySelector(".more-btn").classList.add("dnone"),a[r](A,e=>{s.querySelector(".more-btn-wrap .preload-spinner").classList.add("dnone"),e.list.length&&s.querySelector(".more-btn").classList.remove("dnone"),insertListToRenderContainer(t,e.list)})})}}initGenres(){this.loader.genresList(e=>{document.querySelector("#genres .render-genres").appendChild(this.renderer.renderGenresList(e).node)})}initDisplayingAuthBtns(){getSessionId()?(document.querySelector(".logout-btn").classList.remove("dnone"),document.querySelector(".go-login-page-btn").classList.add("dnone")):(document.querySelector(".logout-btn").classList.add("dnone"),document.querySelector(".go-login-page-btn").classList.remove("dnone"))}initGoToTopBtn(){const e=document.querySelector(".go-to-top"),t=()=>{500<window.pageYOffset?e.classList.contains("show")||e.classList.add("show"):e.classList.contains("show")&&e.classList.remove("show")};t(),window.addEventListener("scroll",e=>{t()}),e.addEventListener("click",e=>{const t=Math.round(window.pageYOffset/50),A=setInterval(()=>{var e=Math.max(0,window.pageYOffset-t);if(window.scrollTo({top:e}),!e)return clearInterval(A)},1)})}}document.addEventListener("DOMContentLoaded",e=>{const t=new App;window.app=()=>t});class Auth{constructor(e){this.formSelector=e,this.form=document.querySelector(this.formSelector),this.submitBtn=this.form.querySelector(".submit-btn"),this.initForm()}initForm(){this.form.addEventListener("submit",e=>{if(e.preventDefault(),!this.submitBtn.classList.contains("disable")){this.submitBtn.classList.add("disable");var e=this.form.querySelector("#email").value,t=this.form.querySelector("#passwd").value;const a=new XMLHttpRequest;a.open("POST","https://www.anilibria.tv/public/login.php"),a.onload=()=>{if(this.submitBtn.classList.remove("disable"),200==a.status){var e=JSON.parse(a.response);if("ok"==e.err){localStorage.setItem("sessionId",e.sessionId);const t=createGlobalAlertComponent("success","Успешно!");setTimeout(()=>{t.close()},2e3),document.location.hash="#",document.querySelector(".logout-btn").classList.remove("dnone"),document.querySelector(".go-login-page-btn").classList.add("dnone")}else{const A=createGlobalAlertComponent("danger",e.mes);setTimeout(()=>{A.close()},4500)}}else{const r=createGlobalAlertComponent("danger","Сервер не доступен");setTimeout(()=>{r.close()},4500)}};var A=new FormData;A.append("mail",e),A.append("passwd",t),A.append("fa2code",""),A.append("csrf","1"),a.send(A)}})}logout(){localStorage.removeItem("sessionId"),document.location.hash="#page:login",document.querySelector(".logout-btn").classList.add("dnone"),document.querySelector(".go-login-page-btn").classList.remove("dnone"),app().cacheProvider.unsetCache("favouritesList")}}class CacheProvider{constructor(){this.cache={},this.lifetime={},this.createAt={},this.init(),setInterval(()=>{this.manager()},1e3)}init(){var e=localStorage.getItem("cache");e&&(e=JSON.parse(e),this.cache=e.cache,this.lifetime=e.lifetime,this.createAt=e.createAt)}setCache(e,t,A){this.cache[e]=t,this.lifetime[e]=A,this.createAt[e]=Math.round((new Date).getTime()/1e3),this.saveCache()}saveCache(){localStorage.setItem("cache",JSON.stringify({cache:this.cache,lifetime:this.lifetime,createAt:this.createAt}))}cacheable(t,e,A,r){if(this.cache[t])return A(this.cache[t]);e(e=>{this.setCache(t,e,r),A(e)})}unsetCache(e){this.cache[e]&&(delete this.cache[e],delete this.lifetime[e],delete this.createAt[e],this.saveCache())}manager(){var e,t=Math.round((new Date).getTime()/1e3);for(e in this.cache)this.lifetime[e]&&t-this.createAt[e]>this.lifetime[e]&&this.unsetCache(e)}}class Loader{constructor(){}homePageUpToLoad(e,t){anilibriaRequest("title/updates",{after:e,limit:_CONF.perPage.home,filter:getItemCardFields()},e=>t(e))}searchPageUpToLoad(e,t){var A=decodeURI(document.location.hash.split("sq:")[1]);anilibriaRequest("title/search",{after:e,limit:_CONF.perPage.search,filter:getItemCardFields(),search:A},e=>t(e))}genresPageUpToLoad(e,t){var A=getSelectedGenres();anilibriaRequest("title/search",{search:"",filter:getItemCardFields(),genres:A.join(","),after:e,limit:_CONF.perPage.search},e=>t(e))}favouritesList(e){const A=getSessionId();if(!A)return setTimeout(()=>document.location.hash="#page:login",20);app().cacheProvider.cacheable("favouritesList",t=>{anilibriaRequest("v2.13:getFavorites",{session:A,limit:100,filter:getItemCardFields(!0)},e=>t(e))},e,300)}genresList(e){app().cacheProvider.cacheable("genresList",t=>{anilibriaRequest("genres",{sorting_type:1},e=>t(e))},e,10800)}scheduleList(e){app().cacheProvider.cacheable("scheduleList",e=>{anilibriaRequest("title/schedule",{filter:getItemCardFields()},e)},e,10800)}}class PostRender{constructor(){}itemCard(e){e=nodeFromHTML(e);return e.querySelector(".thumbnail-img").addEventListener("load",e=>{e.currentTarget.parentNode.parentNode.classList.add("load-ready")}),e}single(e,t){var A,e=nodeFromHTML(e),r=this.tabs(app().renderer.renderTabs({name:"video",tabs:{"player-container":{btn:'<span class="mdi mdi-television-play"></span> Смотреть',content:`<div class="player" id="main-player-${t.id}"></div>`},"torrents-container":{btn:'<span class="mdi mdi-download"></span> Скачать',content:app().renderer.renderTorrents(t)}},active:"player-container"}));e.querySelector(".video-container").appendChild(r);const a={id:"main-player-"+t.id,default_quality:"720p",preroll_deny:"",file:[]};for(A in t.player.list){let e="[480p]https://"+t.player.host+t.player.list[A].hls.sd;t.player.list[A].hls.hd&&(e+=",[720p]https://"+t.player.host+t.player.list[A].hls.hd),t.player.list[A].hls.fhd&&(e+=",[1080p]https://"+t.player.host+t.player.list[A].hls.fhd),a.file.push({id:"s"+A,skip:t.player.list[A].skips.opening.length?t.player.list[A].skips.opening.join("-"):null,title:"Серия "+A,poster:t.player.list[A].preview?"//"+_CONF.domen+t.player.list[A].preview:null,download:null,file:e})}return setTimeout(()=>{new Playerjs(a)},30),e.querySelector(".fav-btn-wrap").appendChild(app().renderer.renderFavoriteBtn(t).node),e.querySelector(".thumbnail-img").addEventListener("load",e=>{e.currentTarget.parentNode.classList.add("load-ready")}),e}favoriteBtn(e,A){const r=nodeFromHTML(e);return getSessionId()&&(r.querySelector(".state.unset-from").classList.add("dnone"),r.querySelector(".state.set-to").classList.remove("dnone"),app().loader.favouritesList(t=>{for(let e=0;e<t.length;e++)if(A==t[e].id){r.querySelector(".state.unset-from").classList.remove("dnone"),r.querySelector(".state.set-to").classList.add("dnone");break}r.classList.remove("dnone")}),r.addEventListener("click",e=>{e.currentTarget.querySelector(".unset-from").classList.contains("dnone")?addToFavourites(A,e=>{r.querySelector(".state.unset-from").classList.remove("dnone"),r.querySelector(".state.set-to").classList.add("dnone")}):removeFromFavourites(A,e=>{r.querySelector(".state.unset-from").classList.add("dnone"),r.querySelector(".state.set-to").classList.remove("dnone")})})),r}genreBtn(e){e=nodeFromHTML(e);return e.addEventListener("click",e=>{e.preventDefault();var t=e.currentTarget.getAttribute("data-genre-name");let A=document.location.hash.split("sg:")[1];var r=(A=A?A.split(",").map(e=>decodeURI(e)):[]).indexOf(t);-1===r?(A.push(t),e.currentTarget.classList.add("active")):(A.splice(r,1),e.currentTarget.classList.remove("active")),document.location.hash="page:genres;sg:"+A.join(",")}),e}tabs(e){const A=nodeFromHTML(e);return A.querySelectorAll(".tabs-nav .tab").forEach(e=>{e.addEventListener("click",e=>{A.querySelector(".tabs-nav .tab.active").classList.remove("active"),A.querySelector(".tabs-content .tab-content.active").classList.remove("active");var t=e.currentTarget.getAttribute("data-tab");e.currentTarget.classList.add("active"),A.querySelector(`.tab-content[data-tab="${t}"]`).classList.add("active")})}),A}}class Renderer{constructor(){}renderThumbnail(e){let t=e.status.string||"Завершен";e.inSchedule&&(t=e.inSchedule.isToday?'<span class="mdi mdi-flag-checkered"></span> Сегодня':'<span class="mdi mdi-flag-checkered"></span> '+(e.inSchedule.string.charAt(0).toUpperCase()+e.inSchedule.string.slice(1)));var A=e.localPlayerData&&e.localPlayerData.currentEpisode==e.player.episodes.last?'<div class="thumb-label watched">Просмотрено</div>':"";return`
			<div class="component thumbnail">
				<img src="//anilibria.tv${e.posters.medium.url}" class="thumbnail-img">
				<img 
					src="data:image/jpeg;base64,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" 
					class="poster-placeholder"
				>
				<div class="hover-effect">
					<span class="mdi mdi-arrow-right"></span>
				</div>
				${A}
				<div class="thumb-label status">${t}</div>
				<div class="thumb-label series">Серий ${e.player.episodes.last}</div>
			</div>
		`}renderItemCard(e){var t=e.genres.join(", "),A=this.renderThumbnail(e),A=`<a href="#page:single;id${e.id}" class="no-decoration item-link">
			<div class="component card item-card" data-id="${e.id}">
				${A}
				<div class="info">
					<div class="title">${e.names.ru} (<span class="year">${e.season.year}</span>)</div>
					<div class="meta">
						<div class="genres">${t}</div>
						<div class="type">${e.type.full_string}</div>
					</div>
				</div>
			</div>
		</a>`;return{string:A,node:app().postRender.itemCard(A)}}renderTorrents(A){let r='<div class="component torrents">';for(let t=0;t<A.torrents.list.length;t++){var a=A.torrents.list[t];let e=a.total_size/1024/1024;e=1024<e?(e/1024).toString().split(".")[0]+"."+(e/1024).toString().split(".")[1].substr(0,2)+" ГБ":e.toString().split(".")[0]+"."+e.toString().split(".")[1].substr(0,2)+" МБ",r+=`
				<div class="torrent" data-torrent-id="${a.torrent_id}">
					<div class="series">Серии ${a.episodes.string}</div>
					<div class="quality">${a.quality.string}</div>
					
					<div class="seed-leech">
						<span class="seed">
							<span class="mdi mdi-arrow-up"></span>
							${a.seeders}
						</span>
						<span class="leech">
							<span class="mdi mdi-arrow-down"></span>
							${a.leechers}
						</span>
					</div>
					<div class="download">
						<a href="//anilibria.tv${a.url}" class="std-btn btn-success" target="_blank">
							<span class="mdi mdi-download"></span>
							<span class="btn-label">Скачать</span>
							<span class="btn-tsize">${e}</span>
						</a>
					</div>
				</div>
			`}return r+="</div>"}renderFavoriteBtn(e){var t=`<button class="std-btn btn-warning fav-btn dnone" data-id="${e.id}">
			<span class="state unset-from">
				<span class="mdi mdi-star"></span>
				В избранном
			</span>
			<span class="state set-to">
				<span class="mdi mdi-star-outline"></span>
				Добавить в избранное
			</span>
		</button>`;return{html:t,node:app().postRender.favoriteBtn(t,e.id)}}renderTabs(e){let t='<div class="tabs-nav">',A='<div class="tabs-content">';for(var r in e.tabs){var a=e.active==r?"active":"";t+=`<div class="tab ${a}" data-tab="${r}">${e.tabs[r].btn}</div>`,A+=`<div class="tab-content ${r} ${a}" data-tab="${r}">${e.tabs[r].content}</div>`}return t+="</div>",A+="</div>",`<div class="component tabs ${e.name}" id="${e.name}">
			${t}
			${A}
		</div>`}renderSingle(e){var t=this.renderGenresList(e.genres).html,A=this.renderThumbnail(e),r=e.team.voice.join(", "),a=e.inSchedule?`<div class=""><span class="mdi mdi-flag-checkered"></span> Новая серия: ${e.inSchedule.isToday?"сегодня":e.inSchedule.string}</div>`:"",A=`<div class="component single-item">
			<div class="std-row">
				${A}
				<div class="item-info">
					<h2 class="title"><strong>${e.names.ru}</strong> / ${e.names.en}</h2>
					<div class="time-period">${e.season.string||""} ${e.season.year}</div>
					<div class="genres">${t}</div>
					<div class="type">${e.type.full_string}</div>
					${a}
					<div class="team">
						<div class="voice">
							<strong>Голоса:</strong>
							${r}
						</div>
					</div>
					<div class="description">${e.description}</div>
					<div class="control-panel">
						<div class="fav-btn-wrap"></div>
					</div>
				</div>
			</div>

			<div class="video-container"></div>
		</div>`;return{string:A,node:app().postRender.single(A,e)}}renderPreloadSpinner(){return`<div class="loadingio-spinner-dual-ball-9pyhqeozhs"><div class="ldio-jyt13pqa73">
			<div></div><div></div><div></div>
			</div></div>`}renderGenreBtn(e){e=`<a 
			href="#page:genres;sg:${e}" 
			class="std-btn genre-btn" 
			data-genre-name="${e}"
		>
			${e}
		</a>`;return{html:e,node:app().postRender.genreBtn(e)}}renderGenresList(t){var A=document.createElement("DIV");A.classList.add("genres-wrap");let r='<div class="genres-wrap">';for(let e=0;e<t.length;e++){var a=this.renderGenreBtn(t[e]);A.appendChild(a.node),r+=a.html}return{html:r+="</div>",node:A}}}class Router{constructor(e,t,A){this.containerSelector=e,this.container=document.querySelector(this.containerSelector),this.defaultPageId=t,this.notFoundPageId=A,this.initers={};var r=this.container.querySelectorAll(".page[id]");this.pages={};for(let e=0;e<r.length;e++)this.pages[r[e].getAttribute("id")]=r[e];this.currentPage="default-val",this.currentPath="default-val",this.zindex=1}goToPage(e){return void 0===e?document.location.hash="page:"+this.defaultPageId:void 0===this.pages[e]?this.goToPage(this.notFoundPageId):(this.container.querySelectorAll(".page.show").forEach(e=>e.classList.remove("show")),void 0!==this.pages[e]&&(this.initers._page&&this.initers._page(this,e),this.initers[e]&&this.initers[e](this),this.pages[e].style.zIndex=this.zindex,this.zindex++),this.pages[e]?.classList.add("show"),window.scrollTo({top:0}),this.currentPage=e,void(this.currentPath=document.location.hash))}urlMonitor(){setInterval(()=>{var e=document.location.hash.split("page:")[1];document.location.hash!=this.currentPath&&this.goToPage(e?.split(";")[0])},10)}initPage(e,t){this.initers[e]=t}}class StoredPlayerDataManager{constructor(){this.localStorageItemName="player_data_backup",this.restorePlayerDataFromBackup(),this.cleanupBackupedPlayerData(),setInterval(()=>{this.backupPlayerData()},3e3),setInterval(()=>{this.cleanupBackupedPlayerData()},3e5)}backupPlayerData(){var e,t=getStorablePlayerData(),A=this.getBackupedPlayerData();for(e in t)A[e]?(A[e].currentEpisode=t[e].currentEpisode,A[e].timing.watched=t[e].timing.watched,A[e].timing.len=t[e].timing.len):A[e]=t[e];localStorage.setItem(this.localStorageItemName,JSON.stringify(A))}getBackupedPlayerData(){var e=localStorage.getItem(this.localStorageItemName);return e?JSON.parse(e):{}}restorePlayerDataFromBackup(){var e,t=this.getBackupedPlayerData(),A=document.location.host+document.location.pathname,r=(new Date).getTime();for(e in t){var a=t[e].currentEpisode,s=t[e].timing.watched,n=t[e].timing.len||0;localStorage.setItem("pljsplayfrom_main-player-"+e+A,`{x-${a-1}-s${a}}${s}.0--${n}.0--`+r)}}cleanupBackupedPlayerData(){var e,t=this.getBackupedPlayerData();if(Object.keys(t).length<=300)return!1;let A=-1,r=Number.MAX_VALUE;for(e in t)t[e].timing.watchedAt<r&&(A=e,r=t[e].timing.watchedAt);t[A]&&delete t[A],localStorage.setItem(this.localStorageItemName,JSON.stringify(t))}}const _CONF={domen:"anilibria.tv",api:{domen:"api.anilibria.tv",ver:"v3"},perPage:{home:20,search:20,genres:20},numbOfRelevant:12},getSessionId=()=>{var e=localStorage.getItem("sessionId");return e||!1},stdXHR=(e,t,A)=>{const r=new XMLHttpRequest;return r.open(e,t),r.setRequestHeader("Cache-Control","no-cache, no-store, max-age=0"),r.onload=()=>{if(200==r.status)A(r);else{404==r.status&&app().router.goToPage("not-found");const e=createGlobalAlertComponent("danger","Ошибка загрузки данных");setTimeout(()=>e.close(),3e3)}},r.onerror=()=>{const e=createGlobalAlertComponent("danger","Сервер не доступен");setTimeout(()=>e.close(),3e3)},r},showMobNav=()=>{document.querySelector(".btn-nav-on-mob-show").classList.add("active"),document.querySelectorAll(".navigation-main-wrapper, .userbar-wrapper").forEach(e=>{e.classList.add("show")})},hideMobNav=()=>{document.querySelector(".btn-nav-on-mob-show").classList.remove("active"),document.querySelectorAll(".navigation-main-wrapper, .userbar-wrapper").forEach(e=>{e.classList.remove("show")})},makeSelectedGenresActivated=()=>{let t=document.location.hash.split("sg:")[1];t=t?t.split(",").map(e=>decodeURI(e)):[],document.querySelectorAll("#genres .render-genres .genre-btn.active").forEach(e=>e.classList.remove("active"));for(let e=0;e<t.length;e++)document.querySelector(`#genres .render-genres .genre-btn[data-genre-name="${t[e]}"]`)?.classList.add("active")},getItemCardFields=e=>!0===e?["id","code","names","genres","posters","status","player","season","type"]:["id","code","names","genres","posters.medium.url","status","player.episodes","season","type"],setPageTitle=e=>{document.querySelector("head title").innerHTML=e},nodeFromHTML=e=>{var t=document.createElement("DIV");return t.innerHTML=e,item=t.childNodes[0]},addToFavourites=(e,t)=>{var A=getSessionId();A&&anilibriaRequest("user/favorites",{session:A,title_id:e},e=>{app().cacheProvider.unsetCache("favouritesList"),t(e)},"PUT")},removeFromFavourites=(e,t)=>{var A=getSessionId();A&&anilibriaRequest("user/favorites",{session:A,title_id:e},e=>{app().cacheProvider.unsetCache("favouritesList"),t(e)},"DELETE")},insertListToRenderContainer=(t,A)=>{for(let e=0;e<A.length;e++)t.appendChild(app().renderer.renderItemCard(A[e]).node)},anilibriaRequest=(e,t,A,r)=>{t=t||{},r=r||"GET";let a=_CONF.api.ver,s=(-1!=e.indexOf(":")&&([a,e]=e.split(":")),`//${_CONF.api.domen}/api/${a}/`+e);t.filter&&(t.filter=t.filter.join(",")),0===t.after&&delete t.after;e=new URLSearchParams(t).toString();e&&(s+="?"+e),stdXHR(r,s,e=>{e=JSON.parse(e.response);A(e)}).send()},getSelectedGenres=()=>{var e=document.location.hash.split("sg:")[1];return(e=decodeURI(e)).length?e.split(","):[]},getStorablePlayerData=()=>{var e,t,A,r={};for(e of Object.keys(localStorage))-1!=e.indexOf("pljsplayfrom_main-player-")&&(t=parseInt(e.split("pljsplayfrom_main-player-")[1]),A=localStorage.getItem(e),[watched,len,watchedAt]=A.split("}")[1].split("--"),r[t]={currentEpisode:A.split("}")[0].split("s")[1],timing:{watched:parseInt(watched),len:parseInt(len),watchedAt:watchedAt}});return r},transformScheduleList=e=>{var t,A={},r=(new Date).getDay(),a=["понедельник","вторник","среда","четверг","пятница","суббота","воскресенье"];for(t in e)for(var s in e[t].list)A[e[t].list[s].id]||(A[e[t].list[s].id]={day:{num:e[t].day,string:a[e[t].day],isToday:e[t].day==r},item:e[t].list[s]});return A},initers=n=>{n.router.initPage("_page",(e,t)=>{document.querySelectorAll("#single .render-container").forEach(e=>{e.innerHTML=""}),document.querySelector(`#${t} .preload-spinner`)?.classList.remove("dnone"),document.querySelector('[name="search"]').value="",document.querySelectorAll(".page .more-btn").forEach(e=>e.classList.add("dnone")),hideMobNav();t=document.querySelector("#"+t)?.getAttribute("data-title");setPageTitle(t)}),n.router.initPage("login",e=>{getSessionId()&&(document.location.hash="page:"+e.notFoundPageId)}),n.router.initPage("home",e=>{n.loader.homePageUpToLoad(0,e=>{var t=document.querySelector("#home .render-container");t.innerHTML="",document.querySelector("#home .preload-spinner").classList.add("dnone"),e.list.length&&document.querySelector("#home .more-btn").classList.remove("dnone"),insertListToRenderContainer(t,e.list)})}),n.router.initPage("single",e=>{const s=document.location.hash.split("id")[1];anilibriaRequest("title",{id:s,include:"raw_poster"},t=>{setPageTitle(t.names.ru);const a=t.genres,A=document.querySelector("#single .render-container.main-render");n.loader.scheduleList(e=>{e=transformScheduleList(e),t.inSchedule=!!e[t.id]&&e[t.id].day,A.innerHTML="",document.querySelector("#single .preload-spinner").classList.add("dnone"),A.appendChild(n.renderer.renderSingle(t).node)});t.names.ru,getItemCardFields().join(",");n.cacheProvider.cacheable("relatedTitles_id"+t.id,e=>{anilibriaRequest("title/search",{search:t.names.ru,after:0,limit:_CONF.numbOfRelevant,filter:getItemCardFields()},e)},e=>{e.list.splice(_CONF.numbOfRelevant,e.list.length);const A=e.list.map(e=>e.id),r=document.querySelector("#single .render-container.relevant-items-render");r.innerHTML="",insertListToRenderContainer(r,e.list.filter(e=>e.id!=s)),0<_CONF.numbOfRelevant-r.childNodes.length&&n.cacheProvider.cacheable("additionRelatedTitles_id"+s,e=>{anilibriaRequest("title/search",{search:"",genres:a.splice(0,4).join(","),after:0,limit:_CONF.numbOfRelevant+1,filter:getItemCardFields()},e)},t=>{t.list=t.list.filter(e=>e.id!=s);for(let e=0;e<t.list.length;e++){if(r.childNodes.length>=_CONF.numbOfRelevant)return!1;-1<A.indexOf(t.list[e].id)||r.appendChild(n.renderer.renderItemCard(t.list[e]).node)}},10800)},10800)})}),n.router.initPage("favourites",e=>{n.loader.favouritesList(A=>{const r=document.querySelector("#favourites .render-container");document.querySelector("#favourites .preload-spinner").classList.add("dnone"),r.innerHTML="",n.loader.scheduleList(t=>{t=transformScheduleList(t);for(let e=A.length-1;0<=e;e--)A[e].player.episodes=A[e].player.series,A[e].inSchedule=!!t[A[e].id]&&t[A[e].id].day,r.appendChild(n.renderer.renderItemCard(A[e]).node)})})}),n.router.initPage("search",e=>{var t=decodeURI(document.location.hash.split("sq:")[1]);document.querySelector('[name="search"]').value=t,n.loader.searchPageUpToLoad(0,e=>{var t=document.querySelector("#search .render-container");t.innerHTML="",document.querySelector("#search .preload-spinner").classList.add("dnone"),e.list.length&&document.querySelector("#search .more-btn").classList.remove("dnone"),insertListToRenderContainer(t,e.list)})}),n.router.initPage("new-series",e=>{n.cacheProvider.cacheable("new-series",e=>{anilibriaRequest("title/updates",{after:0,limit:60,filter:getItemCardFields()},e)},a=>{const s=document.querySelector("#new-series .render-container");s.innerHTML="",document.querySelector("#new-series .preload-spinner").classList.add("dnone"),n.loader.favouritesList(A=>{var r=getStorablePlayerData();for(let t=0;t<a.list.length;t++)for(let e=0;e<A.length;e++)if(A[e].id==a.list[t].id){r[a.list[t].id]&&(a.list[t].localPlayerData=r[a.list[t].id]),s.appendChild(n.renderer.renderItemCard(a.list[t]).node);break}})},18e3)}),n.router.initPage("genres",e=>{var t=document.location.hash.split("sg:")[1],A=(setTimeout(()=>{makeSelectedGenresActivated()},30),document.querySelector("#genres .render-container"));t?n.loader.genresPageUpToLoad(0,e=>{var t=document.querySelector("#genres .render-container");t.innerHTML="",document.querySelector("#genres .preload-spinner").classList.add("dnone"),e.list.length&&document.querySelector("#genres .more-btn").classList.remove("dnone"),insertListToRenderContainer(t,e.list)}):(A.innerHTML="",document.querySelector("#genres .preload-spinner").classList.add("dnone"))})};
//# sourceMappingURL=all.min.js.map
